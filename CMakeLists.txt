cmake_minimum_required(VERSION 3.16)
project(LR3 CXX)

set(CMAKE_CXX_STANDARD 17)

# –í–∫–ª—é—á–∞–µ–º —Ñ–ª–∞–≥–∏ –ø–æ–∫—Ä—ã—Ç–∏—è
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fprofile-arcs -ftest-coverage")
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -fprofile-arcs -ftest-coverage")

include(FetchContent)
FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG        v1.14.0
)
FetchContent_MakeAvailable(googletest)

add_executable(tests
    test/main.cpp
    test/FBT_test.cpp
    test/array_test.cpp
    test/stack_test.cpp
    test/queue_test.cpp
    test/doubleList_test.cpp
    test/singleList_test.cpp
    test/hashTable_test.cpp
)

target_link_libraries(tests gtest gtest_main)
target_include_directories(tests PRIVATE . test)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ lcov –∏ genhtml
find_program(LCOV_PATH lcov)
find_program(GENHTML_PATH genhtml)

if(NOT LCOV_PATH OR NOT GENHTML_PATH)
    message(WARNING "lcov –∏–ª–∏ genhtml –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! LCOV –æ—Ç—á–µ—Ç –Ω–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.")
endif()

# –¶–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞ LCOV
add_custom_target(coverage-lcov
    COMMAND ${CMAKE_COMMAND} -E echo "=== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫—Ä—ã—Ç–∏—è ==="
    COMMAND ${LCOV_PATH} --directory ${CMAKE_BINARY_DIR} --zerocounters
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ ==="
    COMMAND ${CMAKE_BINARY_DIR}/tests
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö LCOV ==="
    COMMAND ${LCOV_PATH} --directory ${CMAKE_BINARY_DIR} --capture --output-file ${CMAKE_BINARY_DIR}/coverage.info
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –æ—Ç—á—ë—Ç–∞ ==="
    COMMAND ${LCOV_PATH} --remove ${CMAKE_BINARY_DIR}/coverage.info 
        '*/test/*' 
        '*/_deps/*' 
        '*/googletest/*' 
        '*/usr/include/*' 
        --output-file ${CMAKE_BINARY_DIR}/coverage_filtered.info
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á—ë—Ç–∞ LCOV ==="
    COMMAND ${GENHTML_PATH} ${CMAKE_BINARY_DIR}/coverage_filtered.info 
        --output-directory ${CMAKE_BINARY_DIR}/coverage_lcov
        --title "${PROJECT_NAME} - LCOV Coverage"
        --show-details
        --legend
    
    COMMAND ${CMAKE_COMMAND} -E echo ""
    COMMAND ${CMAKE_COMMAND} -E echo "‚úÖ LCOV –û–¢–ß–Å–¢ –ü–û–ö–†–´–¢–ò–Ø –°–û–ó–î–ê–ù"
    COMMAND ${CMAKE_COMMAND} -E echo "üìç –û—Ç–∫—Ä–æ–π—Ç–µ: ${CMAKE_BINARY_DIR}/coverage_lcov/index.html"
    COMMAND ${CMAKE_COMMAND} -E echo "üìä –§–∞–π–ª—ã –ø–æ–∫—Ä—ã—Ç–∏—è: array.h, doubleList.h, hashTable.h, queue.h, singleList.h, stack.h, FBT.h"
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS tests
    COMMENT "Generating LCOV code coverage report"
)

# –¶–µ–ª—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è LCOV –æ—Ç—á—ë—Ç–∞
add_custom_target(coverage-lcov-open
    COMMAND ${CMAKE_COMMAND} -E echo "–û—Ç–∫—Ä—ã–≤–∞—é LCOV –æ—Ç—á—ë—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ..."
    COMMAND xdg-open ${CMAKE_BINARY_DIR}/coverage_lcov/index.html 2>/dev/null ||
            ${CMAKE_COMMAND} -E echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: firefox ${CMAKE_BINARY_DIR}/coverage_lcov/index.html"
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS coverage-lcov
    COMMENT "Opening LCOV coverage report in browser"
)

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Å–≤–æ–¥–∫–∏ LCOV
add_custom_target(coverage-lcov-summary
    COMMAND ${CMAKE_COMMAND} -E echo "=== –°–≤–æ–¥–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è LCOV ==="
    COMMAND ${LCOV_PATH} --summary ${CMAKE_BINARY_DIR}/coverage_filtered.info 2>/dev/null || 
            ${CMAKE_COMMAND} -E echo "–°–≤–æ–¥–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS coverage-lcov
    COMMENT "Showing LCOV coverage summary"
)

# (–û—Å—Ç–∞–≤—å—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ü–µ–ª–∏ coverage, coverage-txt, coverage-open –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ gcovr
find_program(GCOVR_PATH gcovr)
if(NOT GCOVR_PATH)
    message(WARNING "gcovr not found! Coverage reports will not be generated.")
endif()

# –¶–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∏—Å—Ç–æ–≥–æ –æ—Ç—á—ë—Ç–∞
add_custom_target(coverage
    COMMAND ${CMAKE_COMMAND} -E echo "=== –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö ==="
    COMMAND ${CMAKE_COMMAND} -E rm -rf coverage_report
    COMMAND ${CMAKE_COMMAND} -E make_directory coverage_report
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ ==="
    COMMAND ./tests
    
    COMMAND ${CMAKE_COMMAND} -E echo "=== –°–æ–∑–¥–∞–Ω–∏–µ HTML –æ—Ç—á—ë—Ç–∞ ==="
    COMMAND ${CMAKE_COMMAND} -E env "PATH=$ENV{PATH}"
    COMMAND ${CMAKE_COMMAND} -E chdir ${CMAKE_BINARY_DIR}
    COMMAND ${GCOVR_PATH} --root ${CMAKE_SOURCE_DIR}
        --exclude=".*/test/.*"
        --exclude=".*/_deps/.*"
        --exclude=".*/googletest/.*"
        --html coverage_report/coverage.html
        --html-details
        --print-summary
    
    COMMAND ${CMAKE_COMMAND} -E echo ""
    COMMAND ${CMAKE_COMMAND} -E echo "‚úÖ –û–¢–ß–Å–¢ –ü–û–ö–†–´–¢–ò–Ø –°–û–ó–î–ê–ù"
    COMMAND ${CMAKE_COMMAND} -E echo "üìç –û—Ç–∫—Ä–æ–π—Ç–µ: ${CMAKE_BINARY_DIR}/coverage_report/coverage.html"
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS tests
    COMMENT "Generating code coverage report"
)

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
add_custom_target(coverage-txt
    COMMAND ${GCOVR_PATH} --root ${CMAKE_SOURCE_DIR}
        --exclude=".*/test/.*"
        --exclude=".*/_deps/.*"
        --exclude=".*/googletest/.*"
        --txt coverage.txt
        --print-summary
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS tests
    COMMENT "Generating text coverage report"
)

# –¶–µ–ª—å –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ—Ç—á–µ—Ç–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
add_custom_target(coverage-open
    COMMAND ${CMAKE_COMMAND} -E echo "–û—Ç–∫—Ä—ã–≤–∞—é –æ—Ç—á—ë—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ..."
    COMMAND ${CMAKE_COMMAND} -E env "BROWSER=xdg-open"
    COMMAND xdg-open coverage_report/coverage.html 2>/dev/null || 
            ${CMAKE_COMMAND} -E echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: firefox coverage_report/coverage.html"
    
    WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
    DEPENDS coverage
    COMMENT "Opening coverage report in browser"
)